# API Reference — ESP32 Neoclock

Base URL: `http://<device>/api`

This document lists the REST endpoints exposed by the firmware. The web UI uses these endpoints; they are safe to call from scripts and home‑automation systems.

Important: the API reflects the **in‑RAM** configuration. Persistent writes are deferred (see `/api/config` notes).

---

## Configuration

### GET /api/config
Returns the full device configuration (JSON). This is the canonical source for the web UI.

Response (abridged):
```json
{
  "display": {
    "brightness": 80,
    "nightMode": { "enabled": false, "brightness": 20, "startHour": 22, "endHour": 7 },
    "color": { "r": 255, "g": 255, "b": 255 },
    "displayMode": 0,
    "modeSpeed": 0,
    "modeIntensity": 255,
    "color2R": 255,
    "color2G": 128,
    "color2B": 0,
    "dayCycleHours": 24,
    "language": "de"
  },
  "time": { "timezone": "Europe/Berlin", "ntpServer": "pool.ntp.org" },
  "network": { "ssid": "MyWiFi", "hostname": "neoclock" },
  "firmware": { "version": "4.0.0" }
}
```

Notes:
- The response is generated from the runtime `config` structure (current device state).
- Keys `color2R/G/B` are returned as flat properties.

---

### PUT /api/config
Update the full configuration (send the same JSON structure as returned by `GET`).

Behavior:
- Updates the in‑RAM `config` immediately.
- Calls `markConfigDirty()` to persist changes to NVS later (deferred write).
- If `restart` is required for a specific change, the endpoint may return `{ "success": true, "restart": true }`.

Example:
```bash
curl -X PUT http://neoclock.local/api/config -H "Content-Type: application/json" -d @config.json
```

---

### POST /api/config/reset
Factory reset — clears saved configuration and reboots into AP/setup mode.

---

## Display control

### POST /api/display
Real‑time display updates for previewing (does not immediately save to NVS).
Accepts JSON with any of: `brightness`, `r`, `g`, `b`, `mode`, `modeSpeed`, `modeIntensity`, `color2` (object `{r,g,b}`), `dayCycleHours`.

Example:
```bash
curl -X POST http://neoclock.local/api/display \
  -H 'Content-Type: application/json' \
  -d '{"brightness":200, "r":128, "g":64, "b":255, "mode":4, "color2": {"r":255,"g":128,"b":0}}'
```

### POST /api/display/brightness
Set brightness only (form or JSON payload supported).

### POST /api/display/color
Set primary color only.

### POST /api/display/test
Trigger a brief LED test pattern.

---

## WiFi

### GET /api/wifi/scan
Returns list of SSIDs (signal, auth).

### GET /api/wifi/status
Current connection (ssid, ip, rssi).

### POST /api/wifi/connect
Connect to an SSID. Example payload: `{ "ssid": "MyWiFi", "password": "secret" }`.

Important: the device supports **2.4 GHz WiFi only** (not 5 GHz).

---

## Language Management

### GET /api/languages
Returns list of available word clock languages with metadata.

Response:
```json
{
  "languages": [
    { "code": "de", "name": "Deutsch (German)" },
    { "code": "en", "name": "English" }
  ],
  "current": "de",
  "count": 2
}
```

Notes:
- `code`: ISO 639-1 language code (2 letters)
- `name`: Human-readable language name
- `current`: Currently active language code
- New languages can be added via the plugin system (see `CONTRIBUTING_LANGUAGES.md`)

---

### GET /api/languages/current
Returns the currently active language.

Response:
```json
{
  "language": "de",
  "isActive": true
}
```

---

### POST /api/languages/set
Change the active language. The change takes effect immediately.

Request:
```json
{
  "language": "en"
}
```

Response (success):
```json
{
  "success": true,
  "language": "en"
}
```

Response (error - language not available):
```json
{
  "error": "Language not available",
  "requested": "fr"
}
```

Example:
```bash
curl -X POST http://neoclock.local/api/languages/set \
  -H 'Content-Type: application/json' \
  -d '{"language":"de"}'
```

Notes:
- Language changes are persisted to NVS automatically
- Invalid language codes return 404 status
- The word clock display updates immediately upon language change

---

## Time & System

### GET /api/time
Returns current time and timezone info.

### POST /api/time/sync
Trigger immediate NTP sync.

### GET /api/status
Uptime, free memory, firmware version and other diagnostics.

### POST /api/restart
Restart the device.

---

## Firmware Management

### POST /api/firmware/upload
Upload a new firmware `.bin` file to update the device via Over-The-Air (OTA) update.

**Request:**
- Method: `POST`
- Content-Type: `multipart/form-data`
- Form field: `firmware` (binary file, typically `.bin` extension)
- File: Compiled firmware binary (generated by PlatformIO as `software/.pio/build/esp32dev/firmware.bin`)

**Response:**
```json
{
  "success": true
}
```

**Behavior:**
1. Receives firmware file in chunks
2. Writes to flash memory using ESP32 Update library
3. Validates firmware integrity
4. Returns success response
5. **Automatically reboots device** after successful upload (~1 second delay)
6. Device will be unavailable for ~10-30 seconds during reboot

**Error Response:**
```json
{
  "success": false,
  "error": "Update failed"
}
```

**Notes:**
- Total upload time depends on file size (typically ~1MB = ~10-15 seconds on WiFi)
- Connection will be lost during reboot - frontend should show reconnection UI
- Only accepts valid ESP32 firmware binaries (invalid files will be rejected)
- Also available at `/api/ota/update` (legacy endpoint)

### GET /api/firmware
Returns current firmware information.

**Response:**
```json
{
  "version": "4.0.0",
  "updateURL": "",
  "autoCheckUpdates": true
}
```

### GET /api/firmware/check-update
Check for available firmware updates (placeholder - not yet implemented).

**Response:**
```json
{
  "updateAvailable": false,
  "latestVersion": "4.0.0",
  "message": "No updates available"
}
```

---

## Behavior & Notes
- The API is unauthenticated by default (local network). If exposing to untrusted networks, add network-level protections.
- Many UI operations use `POST /api/display` for instant preview and `PUT /api/config` to persist changes.
- Saves to NVS are deferred to reduce flash wear — configuration changes are written to flash 5 seconds after the last modification.

---

If you want, I can add example responses for every endpoint or generate an OpenAPI (Swagger) spec.