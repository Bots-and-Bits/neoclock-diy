[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

; Serial Monitor
monitor_speed = 115200
monitor_filters = 
    colorize
    esp32_exception_decoder

; Upload settings
upload_speed = 921600
upload_port = /dev/cu.usbserial-*  ; Auto-detect USB port (macOS)

; Build settings
build_flags = 
    -D FIRMWARE_VERSION='"1.0.0"'
    -D FIRMWARE_BUILD_DATE='"${UNIX_TIME}"'
    -D LED_COUNT=115
    -D LED_PIN=13
    -D CORE_DEBUG_LEVEL=3  ; Verbose debug output
    -D CONFIG_ARDUHAL_LOG_COLORS=1
    -D EZTIME_CACHE_NVS=1  ; Cache timezone data to NVS for offline resilience

; Library Dependency Finder - use default to auto-detect framework libraries
lib_ldf_mode = deep

; Library dependencies
lib_deps = 
    ; Project libraries
    fastled/FastLED@^3.6.0
    bblanchon/ArduinoJson@^7.0.4
    
    ; ezTime for timezone/NTP
    ropg/ezTime@^0.8.3
    
    ; ESPAsyncWebServer (use me-no-dev's version - widely used)
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git

; OTA settings
upload_protocol = esptool
upload_flags = 
    --before=default_reset
    --after=hard_reset

; Filesystem settings (if using SPIFFS/LittleFS later)
board_build.filesystem = littlefs
board_build.partitions = default.csv

; Extra scripts (optional - for custom build steps)
; extra_scripts = 
;     pre:scripts/build_frontend.py

; ===== OTA Upload Environment =====
; Usage: pio run -e esp32dev_ota -t upload
; Set device IP or hostname in upload_port
; Note: Connection may reset during reboot - this is normal if upload reached 100%
[env:esp32dev_ota]
extends = env:esp32dev
upload_protocol = custom
upload_port = neoclock.local 
upload_flags = 
upload_command = curl --max-time 120 -F "firmware=@$SOURCE" http://$UPLOAD_PORT/api/firmware/upload 2>&1 | tee /tmp/ota_upload.log; if grep -q "100 " /tmp/ota_upload.log; then echo "Upload complete, device rebooting..."; exit 0; else exit 1; fi
